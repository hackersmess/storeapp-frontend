<div class="itinerary-container">
  @if (loading()) {
    <div class="loading">
      <div class="spinner"></div>
      <p>Caricamento...</p>
    </div>
  }
  @if (error()) {
    <div class="error-message">
      {{ error() }}
      <button (click)="loadGroupAndItinerary(group()?.id || 0)" *ngIf="group()">Riprova</button>
    </div>
  }

  <!-- No Itinerary - Create Prompt -->
  @if (!itinerary() && !loading() && group()) {
    <div class="no-itinerary">
      <div class="no-itinerary-content">
        <ng-icon name="lucideCalendar" size="64"></ng-icon>
        <h2>Nessun itinerario</h2>
        <p>Crea un itinerario per iniziare a pianificare le attività del gruppo.</p>
        <button class="btn-primary" (click)="createItinerary()">
          <ng-icon name="lucidePlus"></ng-icon>
          Crea Itinerario
        </button>
      </div>
    </div>
  }

  <!-- Itinerary exists -->
  @if (itinerary() && !loading()) {
    <div class="itinerary-content">
      <!-- Header -->
      <div class="itinerary-header">
        <button class="btn-back" (click)="goBack()">
          <ng-icon name="lucideChevronLeft"></ng-icon>
        </button>
        <div class="header-info">
          <h1>{{ itinerary()!.name }}</h1>
          <div class="header-meta">
            @if (group()?.vacationStartDate && group()?.vacationEndDate) {
              <span class="date-range">
                <ng-icon name="lucideCalendar"></ng-icon>
                {{ formatDate(group()!.vacationStartDate) }} -
                {{ formatDate(group()!.vacationEndDate) }}
              </span>
            }
            <span class="activity-count">
              {{ itinerary()!.activityCount }}
              {{ itinerary()!.activityCount === 1 ? 'attività' : 'attività' }}
            </span>
          </div>
        </div>
      </div>

      <!-- Progress Bar -->
      <div class="progress-section">
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="progressPercentage()"></div>
        </div>
        <span class="progress-text">
          {{ itinerary()!.completedActivitiesCount }} / {{ itinerary()!.activityCount }} completate
          ({{ progressPercentage() }}%)
        </span>
      </div>

      <!-- Quick Actions -->
      <div class="quick-actions">
        <button class="btn-primary" (click)="openCreateActivity()">
          <ng-icon name="lucidePlus"></ng-icon>
          Nuova Attività
        </button>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button
          class="tab"
          [class.active]="currentView() === 'calendar'"
          (click)="currentView.set('calendar')"
        >
          <ng-icon name="lucideCalendar"></ng-icon>
          Calendario
        </button>
        <button
          class="tab"
          [class.active]="currentView() === 'map'"
          (click)="currentView.set('map')"
        >
          <ng-icon name="lucideMap"></ng-icon>
          Mappa
        </button>
      </div>

      <!-- Calendar View -->
      @if (currentView() === 'calendar') {
        <div class="calendar-view">
          <!-- Mini Calendar Navigation -->
          <div class="mini-calendar">
            @for (day of calendarDays(); track day.date) {
              <div
                class="calendar-day-mini"
                [class.selected]="selectedDate() === day.date"
                [class.today]="day.isToday"
                [class.has-activities]="day.activityCount > 0"
                (click)="selectedDate.set(day.date)"
              >
                <div class="day-name">{{ day.dayOfWeek }}</div>
                <div class="day-number">{{ formatDate(day.date) }}</div>
                @if (day.activityCount > 0) {
                  <div class="activity-badge">{{ day.activityCount }}</div>
                }
              </div>
            }
          </div>

          <!-- Activity List by Day -->
          <div class="activities-list">
            @for (day of calendarDays(); track day.date) {
              @if (day.activities.length > 0) {
                <div class="day-section" [id]="'day-' + day.date">
                  <h3 class="day-header">{{ formatDateLong(day.date) }}</h3>

                  <div class="day-activities">
                    @for (activity of day.activities; track activity.id) {
                      <div class="activity-card" (click)="openActivityDetail(activity)">
                        <div class="activity-header">
                          <div class="activity-title">
                            <h4>{{ activity.title }}</h4>
                            @if (activity.locationName) {
                              <span class="location">
                                <ng-icon name="lucideMapPin"></ng-icon>
                                {{ activity.locationName }}
                              </span>
                            }
                          </div>
                          <button
                            class="btn-icon"
                            [class.completed]="activity.isCompleted"
                            (click)="toggleActivityCompletion(activity.id, $event)"
                          >
                            <ng-icon
                              [name]="activity.isCompleted ? 'lucideCheck' : 'lucideX'"
                            ></ng-icon>
                          </button>
                        </div>

                        @if (activity.start && activity.end) {
                          <div class="activity-time">
                            <ng-icon name="lucideClock"></ng-icon>
                            {{ formatTime(activity.start) }} - {{ formatTime(activity.end) }}
                          </div>
                        }

                        <div class="activity-stats">
                          <span class="stat">
                            <ng-icon name="lucideUsers"></ng-icon>
                            {{ activity.confirmedCount }} confermati
                          </span>
                          @if (activity.maybeCount > 0) {
                            <span class="stat maybe">{{ activity.maybeCount }} forse</span>
                          }
                          @if (activity.declinedCount > 0) {
                            <span class="stat declined">{{ activity.declinedCount }} no</span>
                          }
                        </div>
                      </div>
                    }
                  </div>
                </div>
              }
            }
          </div>
        </div>
      }

      <!-- Map View -->
      @if (currentView() === 'map') {
        <div class="map-view">
          <div class="map-placeholder">
            <ng-icon name="lucideMap" size="48"></ng-icon>
            <p>Vista mappa - Da implementare</p>
          </div>
        </div>
      }
    </div>
  }

  <!-- Create Activity Modal -->
  @if (showCreateActivityModal()) {
    <div class="modal-overlay" (click)="showCreateActivityModal.set(false)">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Nuova Attività</h2>
          <button class="btn-close" (click)="showCreateActivityModal.set(false)">×</button>
        </div>

        <div class="modal-body">
          <div class="form-group">
            <label>Titolo *</label>
            <input
              type="text"
              [(ngModel)]="activityForm().name"
              placeholder="Es: Visita Colosseo"
              class="form-control"
            />
          </div>

          <div class="form-group">
            <label>Data</label>
            <input type="date" [(ngModel)]="activityForm().scheduledDate" class="form-control" />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Ora inizio</label>
              <input type="time" [(ngModel)]="activityForm().startTime" class="form-control" />
            </div>
            <div class="form-group">
              <label>Ora fine</label>
              <input type="time" [(ngModel)]="activityForm().endTime" class="form-control" />
            </div>
          </div>

          <div class="form-group">
            <label>Luogo</label>
            <input
              type="text"
              [(ngModel)]="activityForm().locationName"
              placeholder="Es: Piazza del Colosseo, 1"
              class="form-control"
            />
          </div>

          <div class="form-group">
            <label>Descrizione</label>
            <textarea
              [(ngModel)]="activityForm().description"
              placeholder="Aggiungi dettagli..."
              rows="3"
              class="form-control"
            ></textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn-secondary" (click)="showCreateActivityModal.set(false)">
            Annulla
          </button>
          <button class="btn-primary" (click)="createActivity()" [disabled]="!activityForm().name">
            Crea
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Activity Detail Modal -->
  @if (showActivityDetailModal() && selectedActivity()) {
    <div class="modal-overlay" (click)="showActivityDetailModal.set(false)">
      <div class="modal-content modal-large" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>{{ selectedActivity()!.name }}</h2>
          <button class="btn-close" (click)="showActivityDetailModal.set(false)">×</button>
        </div>

        <div class="modal-body">
          <div class="detail-section">
            @if (selectedActivity()!.scheduledDate) {
              <div class="detail-item">
                <ng-icon name="lucideCalendar"></ng-icon>
                <span>{{ formatDateLong(selectedActivity()!.scheduledDate!) }}</span>
              </div>
            }
            @if (selectedActivity()!.startTime) {
              <div class="detail-item">
                <ng-icon name="lucideClock"></ng-icon>
                <span>
                  {{ formatTime(selectedActivity()!.startTime) }} -
                  {{ formatTime(selectedActivity()!.endTime) }}
                </span>
              </div>
            }
            @if (selectedActivity()!.locationName) {
              <div class="detail-item">
                <ng-icon name="lucideMapPin"></ng-icon>
                <span>{{ selectedActivity()!.locationName }}</span>
              </div>
            }
          </div>

          @if (selectedActivity()!.description) {
            <div class="detail-section">
              <h3>Descrizione</h3>
              <p>{{ selectedActivity()!.description }}</p>
            </div>
          }

          <!-- Participants -->
          <div class="detail-section">
            <h3>Partecipanti</h3>
            @if (selectedActivity()!.participants && selectedActivity()!.participants!.length > 0) {
              <div class="participants-list">
                @for (participant of selectedActivity()!.participants; track participant.id) {
                  <div class="participant-item">
                    <div class="participant-info">
                      <span class="participant-name">{{ participant.groupMember.user.name }}</span>
                      <span
                        class="participant-status"
                        [ngClass]="getParticipantStatusClass(participant.status)"
                      >
                        {{ participant.status }}
                      </span>
                    </div>
                  </div>
                }
              </div>
            } @else {
              <p class="empty-state">Nessun partecipante</p>
            }
          </div>

          <!-- Expenses -->
          <div class="detail-section">
            <h3>Spese</h3>
            @if (selectedActivity()!.expenses && selectedActivity()!.expenses!.length > 0) {
              <div class="expenses-list">
                @for (expense of selectedActivity()!.expenses; track expense.id) {
                  <div class="expense-item">
                    <div class="expense-info">
                      <span class="expense-desc">{{ expense.description }}</span>
                      <span class="expense-amount"
                        >{{ expense.amount }} {{ expense.currency }}</span
                      >
                    </div>
                    <span class="expense-payer">Pagato da: {{ expense.paidBy.user.name }}</span>
                  </div>
                }
              </div>
            } @else {
              <p class="empty-state">Nessuna spesa</p>
            }
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn-danger" (click)="deleteActivity(selectedActivity()!.id)">
            <ng-icon name="lucideTrash2"></ng-icon>
            Elimina
          </button>
          <button class="btn-secondary" (click)="showActivityDetailModal.set(false)">Chiudi</button>
        </div>
      </div>
    </div>
  }
</div>
