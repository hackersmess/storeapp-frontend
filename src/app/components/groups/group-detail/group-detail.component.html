<div class="group-detail-container">
  @if (loading()) {
    <div class="loading">
      <div class="spinner"></div>
      <p>Caricamento...</p>
    </div>
  }

  @if (error()) {
    <div class="error-message">
      {{ error() }}
      @if (group()) {
        <button (click)="loadGroup(group()!.id)">Riprova</button>
      }
    </div>
  }

  @if (group() && !loading()) {
    <div class="group-content">
      <!-- Cover Image -->
      <div
        class="group-cover"
        [style.background-image]="
          group()!.coverImageUrl ? 'url(' + group()!.coverImageUrl + ')' : ''
        "
      >
        <div class="cover-overlay">
          <div class="cover-content">
            <h1>{{ group()!.name }}</h1>
            <div class="group-meta">
              <div class="meta-item">
                <ng-icon name="lucideCalendar"></ng-icon>
                @if (group()!.vacationStartDate && group()!.vacationEndDate) {
                  <span>
                    {{ formatDate(group()!.vacationStartDate) }} -
                    {{ formatDate(group()!.vacationEndDate) }}
                  </span>
                } @else {
                  <span>Date non specificate</span>
                }
              </div>
              <div class="meta-item clickable" (click)="setActiveTab('members')">
                <ng-icon name="lucideUsers"></ng-icon>
                <span
                  >{{ group()!.memberCount }}
                  {{ group()!.memberCount === 1 ? 'membro' : 'membri' }}</span
                >
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Mobile Tabs -->
      <div class="tabs-container">
        <button
          class="tab-btn"
          [class.active]="activeTab() === 'calendar'"
          (click)="setActiveTab('calendar')"
          type="button"
        >
          <ng-icon name="lucideCalendar" size="18"></ng-icon>
          <span>Calendario</span>
        </button>
        <button
          class="tab-btn"
          [class.active]="activeTab() === 'activities'"
          (click)="setActiveTab('activities')"
          type="button"
        >
          <ng-icon name="lucideList" size="18"></ng-icon>
          <span>Attività</span>
        </button>
        <button
          class="tab-btn"
          [class.active]="activeTab() === 'map'"
          (click)="setActiveTab('map')"
          type="button"
        >
          <ng-icon name="lucideMap" size="18"></ng-icon>
          <span>Mappa</span>
        </button>
      </div>

      <!-- Tab Content -->
      <div class="tab-content">
        <!-- Calendar Tab -->
        @if (activeTab() === 'calendar') {
          <div class="calendar-section">
            @if (group()!.vacationStartDate && group()!.vacationEndDate) {
              <app-group-calendar
                [vacationStartDate]="group()!.vacationStartDate"
                [vacationEndDate]="group()!.vacationEndDate"
                [activities]="activities()"
                [selectedDate]="selectedDate()"
                (dateSelected)="onDateSelected($event)"
                (activityClick)="onActivityClick($event)"
                (createActivity)="onAddActivity($event)"
              >
              </app-group-calendar>
            } @else {
              <div class="empty-state">
                <ng-icon name="lucideCalendar" size="48"></ng-icon>
                <p>Configura le date del gruppo per visualizzare il calendario</p>
                @if (isAdmin()) {
                  <button class="btn-primary" (click)="editGroup()">Configura Date</button>
                }
              </div>
            }
          </div>
        }

        <!-- Activities List Tab -->
        @if (activeTab() === 'activities') {
          <div class="activities-full-section">
            <app-group-activities-list
              [activities]="activities()"
              [selectedDate]="null"
              [loading]="loadingActivities()"
              (activityClick)="onActivityClick($event)"
              (addActivity)="onAddActivity($event)"
            >
            </app-group-activities-list>
          </div>
        }

        <!-- Map Tab -->
        @if (activeTab() === 'map') {
          <div class="map-section">
            <div class="empty-state">
              <ng-icon name="lucideMap" size="48"></ng-icon>
              <p>Funzionalità mappa in arrivo</p>
              <p class="text-muted">
                Qui potrai visualizzare la mappa con tutte le tappe del viaggio
              </p>
            </div>
          </div>
        }

        <!-- Members Tab -->
        @if (activeTab() === 'members') {
          <div class="members-section">
            <div class="section-header">
              <h2 class="section-title">
                <ng-icon name="lucideUsers"></ng-icon>
                Membri del gruppo
              </h2>
              @if (isAdmin()) {
                <button class="btn-primary" (click)="openAddMemberModal()">
                  <ng-icon name="lucidePlus"></ng-icon>
                  <span>Aggiungi</span>
                </button>
              }
            </div>

            <div class="members-list">
              @for (member of group()!.members; track member.id) {
                <div class="member-card">
                  <div class="member-info">
                    <div class="member-avatar">
                      @if (member.user.avatarUrl) {
                        <img [src]="member.user.avatarUrl" [alt]="member.user.name" />
                      } @else {
                        <div class="avatar-placeholder">
                          {{ member.user.name.charAt(0).toUpperCase() }}
                        </div>
                      }
                    </div>
                    <div class="member-details">
                      <h4 class="member-name">{{ member.user.name }}</h4>
                      <p class="member-email">{{ member.user.email }}</p>
                    </div>
                    @if (member.role === GroupRole.ADMIN) {
                      <span class="role-badge admin">
                        <ng-icon name="lucideShield" size="14"></ng-icon>
                        Admin
                      </span>
                    } @else {
                      <span class="role-badge member">Membro</span>
                    }
                  </div>

                  @if (isAdmin() && canModifyMember(member)) {
                    <div class="member-actions">
                      <button
                        class="action-btn"
                        (click)="toggleMemberRole(member)"
                        title="Cambia ruolo"
                      >
                        <ng-icon name="lucideShield"></ng-icon>
                      </button>
                      <button
                        class="action-btn danger"
                        (click)="removeMember(member)"
                        title="Rimuovi"
                      >
                        <ng-icon name="lucideTrash2"></ng-icon>
                      </button>
                    </div>
                  }
                </div>
              }
            </div>
          </div>
        }
      </div>

      <!-- Group Actions (sempre visibili in fondo) -->
      <div class="group-actions">
        @if (isAdmin()) {
          <button class="action-link" (click)="editGroup()">
            <ng-icon name="lucideEdit"></ng-icon>
            Modifica gruppo
          </button>
          <button class="action-link danger" (click)="showDeleteConfirm.set(true)">
            <ng-icon name="lucideTrash2"></ng-icon>
            Elimina gruppo
          </button>
        }
        <button class="action-link" (click)="leaveGroup()">
          <ng-icon name="lucideLogOut"></ng-icon>
          Abbandona gruppo
        </button>
      </div>
    </div>

    <!-- Activity Modal -->
    <app-activity-modal
      [show]="showActivityModal()"
      [activity]="activityToEdit()"
      [prefilledDate]="selectedDate()"
      [loading]="savingActivity()"
      (close)="closeActivityModal()"
      (save)="onSaveActivity($event)"
    >
    </app-activity-modal>

    <!-- Add Member Modal -->
    @if (showAddMemberModal()) {
      <div class="modal-overlay" (click)="closeAddMemberModal()">
        <div class="modal-container" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h2>Aggiungi Membro</h2>
            <button class="close-btn" (click)="closeAddMemberModal()">×</button>
          </div>

          <div class="modal-body">
            @if (!selectedUserToAdd) {
              <div class="search-section">
                <input
                  type="text"
                  class="search-input"
                  placeholder="Cerca per email o nome..."
                  [(ngModel)]="searchQuery"
                  (input)="onSearchChange(searchQuery)"
                  (blur)="hideSearchResults()"
                />

                @if (searching) {
                  <div class="search-results">
                    <div class="search-loading">Ricerca in corso...</div>
                  </div>
                }

                @if (showSearchResults && searchResults.length > 0) {
                  <div class="search-results">
                    @for (user of searchResults; track user.id) {
                      <div class="search-result-item" (mousedown)="selectUserToAdd(user)">
                        <div class="user-info">
                          <strong>{{ user.name }}</strong>
                          <span class="user-email">{{ user.email }}</span>
                        </div>
                      </div>
                    }
                  </div>
                }

                @if (
                  showSearchResults &&
                  searchResults.length === 0 &&
                  !searching &&
                  searchQuery.length >= 2
                ) {
                  <div class="search-results">
                    <div class="no-results">Nessun utente trovato</div>
                  </div>
                }
              </div>
            } @else {
              <div class="selected-user-section">
                <div class="selected-user">
                  <div class="user-info">
                    <strong>{{ selectedUserToAdd.name }}</strong>
                    <span class="user-email">{{ selectedUserToAdd.email }}</span>
                  </div>
                  <button class="clear-btn" (click)="clearSelectedUser()">×</button>
                </div>

                <div class="role-selection">
                  <label>Ruolo:</label>
                  <div class="role-dropdown">
                    <button class="role-btn" (click)="toggleRoleDropdown()">
                      {{ selectedRole === GroupRole.ADMIN ? 'Admin' : 'Membro' }}
                      <ng-icon name="lucideChevronDown"></ng-icon>
                    </button>
                    @if (roleDropdownOpen) {
                      <div class="role-options">
                        <div class="role-option" (click)="selectRole(GroupRole.MEMBER)">Membro</div>
                        <div class="role-option" (click)="selectRole(GroupRole.ADMIN)">
                          <ng-icon name="lucideShield"></ng-icon>
                          Admin
                        </div>
                      </div>
                    }
                  </div>
                </div>
              </div>
            }
          </div>

          <div class="modal-footer">
            <button class="btn-secondary" (click)="closeAddMemberModal()" [disabled]="addingMember">
              Annulla
            </button>
            <button
              class="btn-primary"
              (click)="confirmAddMember()"
              [disabled]="!selectedUserToAdd || addingMember"
            >
              {{ addingMember ? 'Aggiunta in corso...' : 'Aggiungi' }}
            </button>
          </div>
        </div>
      </div>
    }

    <!-- Confirmation Dialogs -->
    <app-confirm-dialog
      [show]="showDeleteConfirm()"
      title="Conferma Eliminazione"
      message="Sei sicuro di voler eliminare questo gruppo? Questa azione è irreversibile."
      confirmText="Elimina"
      cancelText="Annulla"
      confirmButtonClass="btn-danger"
      [loading]="confirmLoading()"
      (confirm)="deleteGroup()"
      (cancel)="showDeleteConfirm.set(false)"
    >
    </app-confirm-dialog>

    <app-confirm-dialog
      [show]="showLeaveGroupConfirm()"
      [title]="leaveConfirmTitle()"
      [message]="leaveConfirmMessage()"
      [confirmText]="
        leaveStatus?.canLeave
          ? leaveStatus?.willDeleteGroup
            ? 'Abbandona ed Elimina'
            : 'Abbandona'
          : 'Chiudi'
      "
      [cancelText]="leaveStatus?.canLeave ? 'Annulla' : ''"
      [confirmButtonClass]="leaveStatus?.canLeave ? 'btn-danger' : 'btn-primary'"
      [loading]="confirmLoading()"
      (confirm)="confirmLeaveGroup()"
      (cancel)="showLeaveGroupConfirm.set(false)"
    >
    </app-confirm-dialog>

    <app-confirm-dialog
      [show]="showRemoveMemberConfirm()"
      [title]="'Rimuovi ' + (memberToRemove?.user.name || 'membro')"
      [message]="
        'Sei sicuro di voler rimuovere ' +
        (memberToRemove?.user.name || 'questo membro') +
        ' dal gruppo?'
      "
      confirmText="Rimuovi"
      cancelText="Annulla"
      confirmButtonClass="btn-danger"
      [loading]="confirmLoading()"
      (confirm)="confirmRemoveMember()"
      (cancel)="showRemoveMemberConfirm.set(false)"
    >
    </app-confirm-dialog>
  }
</div>
