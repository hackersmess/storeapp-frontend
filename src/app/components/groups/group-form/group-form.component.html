<div class="group-form-container">
  <div class="header">
    <h1>{{ isEditMode() ? 'Modifica Gruppo' : 'Crea Nuovo Gruppo' }}</h1>
  </div>

  @if (loading() && isEditMode()) {
    <div class="loading">
      <div class="spinner"></div>
      <p>Caricamento...</p>
    </div>
  }

  @if (error()) {
    <div class="error-message">
      {{ error() }}
    </div>
  }

  @if (!loading()) {
    <form [formGroup]="groupForm" (ngSubmit)="onSubmit()">
      <div class="form-section">
        <h2>Informazioni Gruppo</h2>

        <div class="form-group">
          <label for="name">Nome Gruppo *</label>
          <input
            id="name"
            type="text"
            formControlName="name"
            placeholder="es. Vacanze Estate 2026"
            [class.error]="groupForm.get('name')?.invalid && groupForm.get('name')?.touched"
          />
          @if (groupForm.get('name')?.invalid && groupForm.get('name')?.touched) {
            <div class="error-text">
              @if (groupForm.get('name')?.errors?.['required']) {
                <span>Il nome è obbligatorio</span>
              }
              @if (groupForm.get('name')?.errors?.['minlength']) {
                <span>Il nome deve essere di almeno 3 caratteri</span>
              }
              @if (groupForm.get('name')?.errors?.['maxlength']) {
                <span>Il nome non può superare 200 caratteri</span>
              }
            </div>
          }
        </div>

        <div class="form-group">
          <label for="description">Descrizione</label>
          <textarea
            id="description"
            formControlName="description"
            rows="4"
            placeholder="Descrivi il tuo gruppo..."
            [class.error]="
              groupForm.get('description')?.invalid && groupForm.get('description')?.touched
            "
          ></textarea>
          @if (groupForm.get('description')?.invalid && groupForm.get('description')?.touched) {
            <div class="error-text">
              @if (groupForm.get('description')?.errors?.['maxlength']) {
                <span>La descrizione non può superare 2000 caratteri</span>
              }
            </div>
          }
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="vacationStartDate">Data Inizio <span class="required">*</span></label>
            <input
              id="vacationStartDate"
              type="date"
              formControlName="vacationStartDate"
              required
            />
            @if (
              groupForm.get('vacationStartDate')?.invalid &&
              groupForm.get('vacationStartDate')?.touched
            ) {
              <div class="error-message">La data di inizio è obbligatoria</div>
            }
          </div>

          <div class="form-group">
            <label for="vacationEndDate">Data Fine <span class="required">*</span></label>
            <input id="vacationEndDate" type="date" formControlName="vacationEndDate" required />
            @if (
              groupForm.get('vacationEndDate')?.invalid && groupForm.get('vacationEndDate')?.touched
            ) {
              <div class="error-message">La data di fine è obbligatoria</div>
            }
          </div>
        </div>

        <div class="form-group">
          <label for="coverImageUrl">URL Immagine Copertina</label>
          <input
            id="coverImageUrl"
            type="url"
            formControlName="coverImageUrl"
            placeholder="https://esempio.com/immagine.jpg"
            [class.error]="
              groupForm.get('coverImageUrl')?.invalid && groupForm.get('coverImageUrl')?.touched
            "
          />
          @if (groupForm.get('coverImageUrl')?.invalid && groupForm.get('coverImageUrl')?.touched) {
            <div class="error-text">
              @if (groupForm.get('coverImageUrl')?.errors?.['maxlength']) {
                <span>L'URL non può superare 500 caratteri</span>
              }
            </div>
          }
        </div>
      </div>

      @if (!isEditMode()) {
        <div class="form-section">
          <h2>Membri del Gruppo</h2>
          <p class="section-description">
            Cerca e aggiungi membri al gruppo tramite username o email
          </p>

          <div class="form-group search-container">
            <label for="memberSearch">Cerca Utenti</label>
            <div class="search-input-wrapper">
              <input
                id="memberSearch"
                type="text"
                formControlName="memberSearch"
                placeholder="Cerca per username o email..."
                (focus)="showSearchResults.set(true)"
                (blur)="hideSearchResults()"
              />
              @if (searching()) {
                <div class="search-spinner">
                  <div class="spinner-small"></div>
                </div>
              }
            </div>

            @if (showSearchResults() && searchResults().length > 0) {
              <div class="search-results">
                @for (user of searchResults(); track user.id) {
                  <div class="search-result-item" (click)="selectUser(user)">
                    @if (user.avatarUrl) {
                      <img [src]="user.avatarUrl" [alt]="user.name" />
                    }
                    @if (!user.avatarUrl) {
                      <div class="avatar-placeholder">
                        {{ user.name.charAt(0).toUpperCase() }}
                      </div>
                    }
                    <div class="user-info">
                      <div class="user-name">{{ user.name }}</div>
                      <div class="user-email">{{ user.email }}</div>
                    </div>
                  </div>
                }
              </div>
            }

            @if (
              showSearchResults() &&
              searchResults().length === 0 &&
              groupForm.get('memberSearch')?.value &&
              !searching()
            ) {
              <div class="search-no-results">
                <p>Nessun utente trovato</p>
              </div>
            }
          </div>

          @if (selectedMembers.length > 0) {
            <div class="selected-members">
              <h3>Membri Selezionati ({{ selectedMembers.length }})</h3>
              <div class="members-list">
                @for (member of selectedMembers; track member.user.id) {
                  <div class="member-item">
                    @if (member.user.avatarUrl) {
                      <img [src]="member.user.avatarUrl" [alt]="member.user.name" />
                    }
                    @if (!member.user.avatarUrl) {
                      <div class="avatar-placeholder">
                        {{ member.user.name.charAt(0).toUpperCase() }}
                      </div>
                    }
                    <div class="member-info">
                      <div class="member-name">{{ member.user.name }}</div>
                      <div class="member-email">{{ member.user.email }}</div>
                    </div>
                    <div class="member-actions">
                      <button
                        type="button"
                        class="role-toggle"
                        (click)="toggleRole(member.user.id)"
                        [class.admin]="member.role === GroupRole.ADMIN"
                      >
                        {{ member.role === GroupRole.ADMIN ? 'Admin' : 'Membro' }}
                      </button>
                      <button
                        type="button"
                        class="btn-remove"
                        (click)="removeMember(member.user.id)"
                        title="Rimuovi"
                      >
                        ×
                      </button>
                    </div>
                  </div>
                }
              </div>
            </div>
          }
        </div>
      }

      @if (isEditMode() && isAdmin()) {
        <div class="form-section">
          <!-- Search section for adding members -->
          <div class="form-group search-container">
            <label for="memberSearch">Cerca utenti da aggiungere</label>
            <div class="search-input-wrapper">
              <input
                id="memberSearch"
                type="text"
                formControlName="memberSearch"
                placeholder="Cerca per username o email..."
                (focus)="showSearchResults.set(true)"
                (blur)="hideSearchResults()"
              />
              @if (searching()) {
                <div class="search-spinner">
                  <div class="spinner-small"></div>
                </div>
              }
            </div>

            @if (showSearchResults() && searchResults().length > 0) {
              <div class="search-results">
                @for (user of searchResults(); track user.id) {
                  <div class="search-result-item" (click)="selectUser(user)">
                    @if (user.avatarUrl) {
                      <img [src]="user.avatarUrl" [alt]="user.name" />
                    }
                    @if (!user.avatarUrl) {
                      <div class="avatar-placeholder">
                        {{ user.name.charAt(0).toUpperCase() }}
                      </div>
                    }
                    <div class="user-info">
                      <div class="user-name">{{ user.name }}</div>
                      <div class="user-email">{{ user.email }}</div>
                    </div>
                  </div>
                }
              </div>
            }

            @if (
              showSearchResults() &&
              searchResults().length === 0 &&
              groupForm.get('memberSearch')?.value &&
              !searching()
            ) {
              <div class="search-no-results">
                <p>Nessun utente trovato</p>
              </div>
            }
          </div>

          <!-- Members list -->
          <app-members-list
            [members]="getGroupMembers()"
            [isAdmin]="isCurrentUserAdmin()"
            [showAddButton]="false"
            [title]="'Membri Attuali'"
            [description]="''"
            (removeMember)="removeMemberFromGroup($event)"
            (toggleRole)="toggleMemberRole($event)"
          >
          </app-members-list>
        </div>
      }

      <div class="form-actions">
        <button type="button" class="btn-secondary" (click)="cancel()">Annulla</button>
        <button type="submit" class="btn-primary" [disabled]="loading()">
          {{ loading() ? 'Salvataggio...' : isEditMode() ? 'Salva Modifiche' : 'Crea Gruppo' }}
        </button>
      </div>
    </form>
  }
</div>
